# 产品需求文档 (PRD): "Yusi - 灵魂叙事" (v2.0 Beta)

## 项目
Yusi (v2.0) - Deep Connection

## 核心愿景
从“个人与AI的连接”拓展到“基于深层叙事的社区连接”。在 v1.0 验证了“情景分析”与“日记”的价值后，v2.0 将致力于让孤独的灵魂在广场相遇，并提供极致安全的连接与表达空间。

---

## 1. 🎯 v2.0 战略目标

*   **社区化 (Community)**: 打破 v1.0 的点对点（匹配）孤岛，建立"灵魂广场" (Soul Plaza)，允许基于内容的匿名公开互动。
*   **极致隐私 (Ultimate Privacy)**: 升级 v1.0 的服务器端加密为**客户端密钥管理 (Client-Key Management)**，支持默认密钥与自定义密钥双模式，实现真正的"虽然我们在云端，但只有你能打开"。

---

## 2. 🚀 新增功能范围 (New Epics)

### Epic 3: “灵魂广场” (Soul Plaza)
**PM目标**: 增加用户留存与活跃度，提供低压力的社交表面。

| ID | 功能特性 | 描述 | 优先级 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| **F3.1** | 匿名投递 | 用户可将日记或情景回答“投递”到广场，系统自动生成“情绪卡片”。 | P0 | [已发布] |
| **F3.2** | 情绪共鸣 | 浏览者不能评论，只能点击“共鸣” (Resonate) 或发送特定的“安抚信号” (Signal)。 | P0 | [已发布] |
| **F3.3** | 时空胶囊 | 广场内容按“情绪”而非时间排序，AI 聚合相似经历的人。 | P1 | [已发布] |

### Epic 4: "真正的密室" (Zero-Knowledge Vault)
**PM目标**: 建立无可置疑的信任壁垒，提供灵活的隐私保护方案。

| ID | 功能特性 | 描述 | 优先级 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| **F4.1** | 双密钥模式 | 用户可选择使用「默认密钥」（服务端托管，无需记忆）或「自定义密钥」（用户自行设置，最高安全性）。 | P0 | [已完成] |
| **F4.2** | 前端加密 | 选择自定义密钥时，所有加密工作在前端完成，服务器仅存储密文，确保即使服务器被攻破也无法解密用户数据。 | P0 | [已完成] |
| **F4.3** | 密钥云端备份（可选） | 使用自定义密钥的用户可**自愿选择**是否将密钥加密后保存至云端。如选择保存，用户可联系管理员协助找回密钥；如不保存，密钥丢失则数据无法恢复。**注意：不开启云端备份时 AI 功能不可用。** | P1 | [已完成] |
| **F4.4** | 密钥更换 | 用户可随时更换密钥（默认⇌自定义，或更换自定义密钥）。系统需实现**全量日记转换逻辑**：使用旧密钥解密所有日记，再使用新密钥重新加密后存储。 | P1 | [已完成] |
| **F4.5** | 密钥状态提示 | 前端清晰展示当前使用的密钥模式，自定义密钥模式下提醒用户妥善保管密钥，并标识是否已开启云端备份及 AI 功能可用性。 | P2 | [已完成] |

#### 密钥管理技术细节

**默认密钥模式**:
- 服务端为每个用户生成唯一加密密钥，存储在数据库中
- 用户无需管理密钥，体验便捷
- 安全性依赖服务端安全，适合对隐私要求一般的用户

**自定义密钥模式**:
- 用户在客户端设置密钥，密钥派生使用 PBKDF2/Argon2
- 加密算法采用 AES-256-GCM，加密操作完全在浏览器端完成
- 密文传输至服务端存储，服务端无法解密
- 密钥可选备份至云端（使用管理员公钥加密后存储）

**密钥更换流程**:
1. 用户发起密钥更换请求
2. 前端拉取所有加密日记
3. 使用旧密钥在前端解密
4. 使用新密钥重新加密
5. 批量上传至服务端覆盖原数据
6. 更新用户密钥模式/备份状态

**密钥模式与 AI 功能可用性**:

| 模式 | 云端备份 | RAG/日记搜索 | AI 分析 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| 默认密钥 | N/A | ✅ 可用 | ✅ 可用 | 服务端有密钥，可解密进行 AI 处理 |
| 自定义密钥 | ✅ 开启 | ✅ 可用 | ✅ 可用 | 服务端可用备份密钥解密 |
| 自定义密钥 | ❌ 关闭 | ❌ 不可用 | ❌ 不可用 | 最高隐私模式，服务端无法解密 |

**设计决策**: 选择"自定义密钥 + 不备份"的用户追求最高隐私，愿意牺牲 AI 功能换取绝对安全。系统在前端和后端均做相应检查，确保不会对无法解密的内容进行向量化或 AI 分析。

---

## 3. 🛠 现有功能优化 (Optimizations)

*   **情景室**:
    *   **异步分析 (Async Analysis)**: 解决 v1.0 中提交时阻塞等待 AI 报告的问题。采用消息队列处理生成任务，前端通过 SSE/WebSocket 接收完成通知。 [已完成]
    *   **动态场景**: 给场景增加字段，允许用户投稿场景，先入库，记录投稿人、拒绝原因、状态（0-待审核/1-人工拒绝/2-AI 审核拒绝/3-AI 审核通过/4-人工通过），status>=3 时才展示。暂不实现AI 审核，仅提供人工审核接口且仅管理员userId过滤授权。 [已完成]

*   **架构升级**:
    *   **强制加密检查**: 修复 v1.0 中加密密钥缺失时静默降级为明文存储的安全隐患。 [已完成]
    *   **响应式性能**: 引入 Redis 缓存热点数据（如热门广场卡片）。 [已完成]

---

## 4. 📅 里程碑计划

1.  **Phase 1 (W1-W2)**: 架构优化（强制加密、异步处理）。
2.  **Phase 2 (W3-W5)**: "灵魂广场" 前后端开发。
3.  **Phase 3 (W6-W8)**: "真正的密室" 客户端密钥管理系统开发。

